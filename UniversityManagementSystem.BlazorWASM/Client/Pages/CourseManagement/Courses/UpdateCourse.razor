@inject DialogService _dialogService
@inject NavigationManager _navigationManager
@inject NotificationService _NotificationService
@inject HttpClient _httpClient


<RadzenTemplateForm TItem="CourseUpdateModel" Data="@couseToUpdate" Submit="OnCourseUpdate" Style="max-width:500px; margin:auto; border:1px solid #dcdcdc; padding:1rem; border-radius:0.5rem;">

    <RadzenStack Orientation="Orientation.Vertical" AlignItems="AlignItems.Start" Gap="1rem">

        <!-- Course Category -->
        <CourseCategoryDropDownList OnCourseCategorySelected="SetCourseCategoryId" CourseCategoryId="CourseCategoryId" />

        <!-- Course Name -->
        <RadzenLabel Text="Course Name" Component="label" Style="font-weight:600;" />
        <RadzenTextBox @bind-Value="@CourseName" Placeholder="Enter course name" Style="width:100%;" Name="CourseName" />
        <RadzenRequiredValidator Component="CourseName"
                                 Text="Course name is required"
                                 @bind-Value="@CourseName" />

        <!-- Buttons -->
        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="1rem" Wrap="FlexWrap.Wrap">
            <RadzenButton Text="Update Course"
                          Icon="add_circle_outline"
                          ButtonStyle="ButtonStyle.Success"
                          Shade="Shade.Dark"
                          Size="ButtonSize.Medium"
                          Variant="Variant.Filled"
                          ButtonType="ButtonType.Submit" />

            <RadzenButton Text="Cancel"
                          Icon="dangerous"
                          ButtonStyle="ButtonStyle.Danger"
                          Shade="Shade.Dark"
                          Size="ButtonSize.Medium"
                          Variant="Variant.Filled"
                          Click="cancel" />
        </RadzenStack>
    </RadzenStack>
</RadzenTemplateForm>

@code {

    [Parameter]
    public int? courseId { get; set; }

    private int CourseCategoryId { get; set; }
    private string CourseName { get; set; }

    private bool busy = false;

    public CourseUpdateModel couseToUpdate { get; set; } = new();


    protected override async Task OnInitializedAsync()
    {
        if(courseId is not null || courseId is not 0)
        {
            var data = await _httpClient.GetStringAsync($"{FrontEndApiEndpointsConfig.CourseEndpoint}/{courseId}");
            var result = JsonSerializer.Deserialize<BaseResponse<CourseViewModel>>(data, new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
            if (result.Succeeded)
            {
                CourseName = result.ResponseData.Name;
                CourseCategoryId = result.ResponseData.CourseCategoryId;
            }
            else if (result.Succeeded is false)
            {
                if (result.ExceptionError is not null)
                {
                    ShowErrorNotificationMessage(result.Message, result.ExceptionError);
                }
                else
                {
                    ShowErrorNotificationMessage(result.Message, string.Empty);

                }
            }

        }

    }


    private void ShowErrorNotificationMessage(string ErrorMessage, string ExceptionErrorMessage)
    {
        var message = new NotificationMessage()
        {
            Severity = NotificationSeverity.Error,
            Summary = $"{ErrorMessage}",
            Detail = ExceptionErrorMessage is null ? "" : ExceptionErrorMessage,
            Duration = 40000
        };
        _NotificationService.Notify(message);
    }


    private async Task OnCourseUpdate()
    {
        couseToUpdate.CourseCategoryId = CourseCategoryId;
        couseToUpdate.Name = CourseName;
        couseToUpdate.Id = (int)courseId;

        busy = true;

        var result = await _httpClient.PutAsJsonAsync($"{FrontEndApiEndpointsConfig.CourseEndpoint}", couseToUpdate);
        if (result.IsSuccessStatusCode)
        {
            var data = await result.Content.ReadFromJsonAsync<BaseResponse<CourseViewModel>>();
            if (data.Succeeded)
            {
                busy = false;
                ShowSuccessMessage(data.Message);
                _dialogService.Close(data.ResponseData);
            }
        }
    }

    private void SetCourseCategoryId(int courseCategoryId)
    {
        CourseCategoryId = courseCategoryId;
    }



    private void ShowSuccessMessage(string Message)
    {
        var message = new NotificationMessage()
        {
            Severity = NotificationSeverity.Success,
            Summary = $"Success",
            Detail = $"{Message}",
            Duration = 1000
        };
        _NotificationService.Notify(message);
    }

    private void cancel()
    {
        _dialogService.Close(null);
    }

}
